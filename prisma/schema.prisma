// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int    @id @default(autoincrement())
  firstName    String
  lastName     String
  countryCode  String
  phone        String
  email        String @unique
  passwordHash String

  // Verification flags (0 / 1 / NULL)
  isPhoneVerified Int?
  isEmailVerified Int?

  lockStatus String

  whmcsClientId Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  onboarding Onboarding?

  kycProfile       KycProfile?
  sessions         Session[]
  kycVerifications KycVerification[]
  verifications    VerificationDocument[]

  @@map("users")
}

model Session {
  id        String   @id
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model SuperAdmin {
  id                 Int     @id @default(autoincrement())
  first_name         String
  last_name          String
  email              String  @unique
  mobile             String? @unique
  password           String
  role               String  @default("2")
  status             Boolean @default(true)
  two_factor_enabled Boolean @default(false)
  two_factor_secret  String?

  // Profile Fields
  gender        String?
  date_of_birth DateTime?
  country       String?
  state         String?
  city          String?
  postal_code   String?
  address       String?

  // System Fields
  last_login_at DateTime?
  last_login_ip String?

  created_at DateTime @default(now())
  updated_at DateTime @default(now())
}

model Onboarding {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique
  userId        Int      @unique
  whmcsClientId Int?
  status        String   @default("pending") // pending | completed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding")
}

model KycVerification {
  id         Int      @id @default(autoincrement())
  userId     Int
  type       String
  reference  String?
  status     String
  verifiedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("kyc_verifications")
}

model KycProfile {
  id          Int    @id @default(autoincrement())
  userId      Int    @unique
  accountType String

  firstName String
  lastName  String
  email     String
  phone     String
  country   String

  state         String?
  city          String?
  postalCode    String?
  streetAddress String?

  companyName    String?
  businessType   String?
  gstVerified    Boolean @default(false)
  cinVerified    Boolean @default(false)
  aadharVerified Boolean @default(false)
  digilockerRef  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  verifications VerificationDocument[]

  @@map("kyc_profiles")
}

model VerificationDocument {
  id Int @id @default(autoincrement())

  // Link to user FIRST (verification before KYC)
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Link to KYC AFTER submit (optional)
  kycProfileId Int?
  kycProfile   KycProfile? @relation(fields: [kycProfileId], references: [id], onDelete: Cascade)

  // Verification Type
  verificationType String // "aadhaar" | "gst" | "cin" | "digilocker"

  // Document Numbers (encrypted)
  documentNumber String?

  // Cashfree Response Data
  cashfreeRefId      String? @unique
  verificationStatus String? // "success" | "failed" | "pending"

  // Extracted Data
  extractedData Json?

  // Raw Response
  rawResponse Json?

  // Timestamps
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([userId])
  @@index([kycProfileId])
  @@index([cashfreeRefId])
  @@map("verification_documents")
}
